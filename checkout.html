<html lang="ar" dir="rtl"><head>
  <meta charset="UTF-8">
  <title>ุงูุฏูุน - ูุชุฌุฑ ููุฌ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Tajawal', bold;
      background: #f4f7fb;
      margin: 0;
      padding: 40px;
    }

    .checkout-wrapper {
      justify-content: space-between;
      align-items: flex-start;
      max-width: 1200px;
      margin: auto;
      gap: 30px;
    }

    .checkout-form {
      flex: 0 0 55%;
      min-width: 300px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.08);
    }

    .invoice-box {
      flex: 0 0 40%;
      min-width: 300px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.08);
    }

    input, select {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: linear-gradient(45deg, #5000c0, #5000c0);
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #ffffff;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .summary p {
      margin: 6px 0;
      font-weight: 600;
    }

    .print-btn {
      margin-top: 20px;
    }
  </style>
</head>
<body style="
    padding-right: 0px;
    padding-left: 0px;
    padding-top: 10px;
    padding-bottom: 10px;
">

<div class="checkout-wrapper">
  <!-- ููุฑู ุงูุฏูุน -->
  <div class="checkout-form" style="
    padding-top: 10px;
    padding-right: 10px;
    padding-left: 25px;
    padding-bottom: 10px;
">
    <h2>ุชุฃููุฏ ุงูุทูุจ ูุงูุฏูุน</h2>
    <form id="checkout-form">
      <input type="text" name="name" placeholder="ุงุณูู" required="">
      <input type="email" name="email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" required="">
      <input type="text" name="phone" placeholder="ุฑูู ุงููุงุชู" required="">
      <input type="text" name="address" placeholder="ุงูุนููุงู ุจุงูุชูุตูู" required="">
      
      <label for="locationSelect">ุงุฎุชุฑ ููุทูุชู:</label>
      <select id="locationSelect">
        <option value="">-- ุงุฎุชุฑ --</option>
<option value="30.0444,31.2357">ุงูุฏูู</option>
<option value="30.0566,31.2394">ูุณุท ุงูุจูุฏ</option>
<option value="30.0609,31.2197">ุงูุฒูุงูู</option>
<option value="29.9650,31.2750">ุด ุงุจู ุจุฑูู</option>
<option value="29.9680,31.2720">ุด ุงููุตุฑ</option>
<option value="29.9700,31.2730">ููุทูุฉ ุนูุงุฑุฉ ุงูุจุฑุฌ</option>
<option value="29.9720,31.2760">ุด ุงููุงุณูููู</option>
<option value="29.9730,31.2770">ููุทูุฉ ุนูุงุฑุงุช ุงููุงุณูููู</option>
<option value="29.9740,31.2780">ูุดุชุดูู ุชุจุงุฑู</option>
<option value="29.9750,31.2790">ุด ุงูุจุญุซ ุงูุฌูุงุฆู</option>
<option value="29.9760,31.2800">ุด ุงููุทุนู ุงูุณูุฑู</option>
<option value="29.9770,31.2810">ููุฏุงู ุตูุฑ ูุฑูุด</option>
<option value="29.9780,31.2820">ููุทูุฉ ุงููููุงูููุฉ</option>
<option value="29.9790,31.2830">ุด ูุฑูุฒ ุดุจุงุจ ุงูุจุณุงุชูู</option>
<option value="29.9800,31.2840">ููุทูุฉ ุนูุงุฑุงุฉ ุงูุงูููุงุจุฉ</option>
<option value="29.9810,31.2850">ุด ูุณุชุดูู ุงูููู ุงููุงุญุฏ</option>
<option value="29.9820,31.2860">ู ุงูุฌุฒุงุฆุฑ</option>
<option value="29.9830,31.2870">ุด ููุฑ ุงูุฏูู</option>
<option value="29.9840,31.2880">ุด ุนุจุฏ ุงูููุนู ุฑูุงุถ</option>
<option value="29.9850,31.2890">ููุฏุงู ูููุชุงูุง</option>
<option value="29.9860,31.2900">ุฌุฑุงูุฏ ููู</option>
<option value="29.9870,31.2910">ููุทูุฉ ููุชูุฑูุง</option>
<option value="30.0300,31.2200">ููุทูุฉ ุฏุฌูุฉ</option>
<option value="29.9890,31.2930">ุด 233</option>
<option value="29.9900,31.2940">ููุฑูู</option>
<option value="29.9910,31.2950">ุด ุงูุฒูุฑุงุก</option>
<option value="29.9920,31.2960">ุงููุฌูุน ุงูุชุฌุงุฑู</option>
<option value="29.9930,31.2970">ุด ุงู 50 ุงูุงูู ูุฎููู</option>
<option value="29.9940,31.2980">ููุทูุฉ ุฎูู ุด 90</option>
<option value="29.9950,31.2990">ููุทูุฉ ุจูุชุดู</option>
<option value="29.9960,31.3000">ุด ุงูุชุฌุงุฑู ุชุจุงุฑู</option>
<option value="29.9970,31.3010">ุด ุงูุณุนุงุฏุฉ</option>
<option value="29.9980,31.3020">ุด ูุงุฑููุฑ</option>
<option value="29.9990,31.3030">ููุทูุฉ ุงููุนุฑุงุฌ ุงูุนููู ูุงูุณููู</option>
<option value="30.0000,31.3040">ุด ุนูู ุนุจุฏ ุงูุนุฒูุฒ</option>
<option value="30.0010,31.3050">ููุฏุงู ุงุจู ุนุจุฏุฉ</option>
<option value="30.0020,31.3060">ุงุฑุถ ุงูุจุตุฑู</option>
<option value="30.0030,31.3070">ุด ุงุญูุฏ ุฒูู</option>
<option value="30.0040,31.3080">ุด ุญุณููู ุฏุณููู</option>
<option value="30.0050,31.3090">ุด 9 ุจ</option>
<option value="30.0060,31.3100">ุด 9</option>
<option value="29.9600,31.2500">ุซููุงุช ุงููุนุงุฏู</option>
<option value="29.9610,31.2510">ููุฏุงู ุงูุญุฑูุฉ</option>
<option value="29.9620,31.2520">ุด 105 ููุฏุงู ุงูุงุชุญุงุฏ</option>
<option value="29.9630,31.2530">ุด 77 ุฌุงูุน ุงูุนุฑุจ</option>
<option value="29.9640,31.2540">ุด ุงูููุงุนุจ</option>
<option value="29.9650,31.2550">ุด ุนุฒุจุฉ ุงููุฑุฏ</option>
<option value="29.9660,31.2560">ุด ุงูุจุณุงุชูู</option>
<option value="29.9670,31.2570">ุดุฑูุฉ ุงูููุฑุจุงุก</option>
<option value="29.9680,31.2580">ุณูู ูุฒุฑุนุฉ ุงูุจุท</option>
<option value="29.9690,31.2590">ุด ูุฒุฑุนุฉ ุงูุจุท</option>
<option value="29.9700,31.2600">ุด ุงูููู</option>
<option value="29.9710,31.2610">ุด ุณูู ุฏุงุฑ ุงูุณูุงู</option>
<option value="29.9720,31.2620">ุงูุทุฑูู ุงูุฒุฑุงุนู</option>
<option value="29.9730,31.2630">ูููู ุงููุทุจุนุฉ</option>
<option value="29.9740,31.2640">ุงูุงุฏููุฉ ุงูุณุงุฏุงุช</option>
<option value="29.9750,31.2650">ู ุนูุงุฑุฉ ุญุณูู ุตุฏูู</option>
<option value="29.9760,31.2660">ูุณุชุดูู ุงููุงุฑูู</option>
<option value="29.9770,31.2670">ูุจุฑุฉ ุงููุนุงุฏู</option>
<option value="29.9780,31.2680">ุด 7</option>
<option value="30.0286,31.3273">ุงูููุทู</option>
<option value="30.0511,31.3656">ูุฏููุฉ ูุตุฑ</option>
<option value="30.0059,31.2290">ูุตุฑ ุงููุฏููู</option>
<option value="30.0286,31.2267">ุงููููู</option>
<option value="29.9000,31.3000">ุงููุนุตุฑุฉ</option>
      </select>
      
      <label for="payment-method">ุงุฎุชุฑ ูุณููุฉ ุงูุฏูุน:</label>
      <select name="payment-method" id="payment-method" required="">
        <option value="5021619">๐ณ ุจุทุงูุฉ ุงุฆุชูุงู</option>
        <option value="cod">๐ต ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู</option>
      </select>
      <button type="submit">ุฃุชูุงู ุงูุทูุจ โ</button>
    </form>
  </div>

  <!-- ุงููุงุชูุฑุฉ -->
  <div class="invoice-box" style="
    padding-right: 10px;
    padding-top: 10px;
    padding-left: 10px;
">
    <h2>๐งพ ุงููุงุชูุฑุฉ</h2>
    <div id="invoice">
      <table>
        <thead>
          <tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th></tr>
        </thead>
        <tbody>
        <tr>
          <td> ุนุจูุฉ ุดุงู ุฏูุฏุฒ 6 ูุดุฑูุจ 1 ูุนููุฉ ุณูุฑ</td>
          <td>1</td>
          <td>26.00 ุฌ</td>
        </tr>
        <tr>
          <td>ุนุจูุฉ ุดุงู ุฏูุฏุฒ 6 ูุดุฑูุจ 2 ูุนููุฉ ุณูุฑ</td>
          <td>1</td>
          <td>26.00 ุฌ</td>
        </tr></tbody>
      </table>
      <div class="summary">
        <p>๐ต ุงููุจูุบ: 52.00 ุฌ</p>
        <p>๐ ุงูุฎุตู (10%): 5.20 ุฌ</p>
        <p>๐งพ ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (0%): 0.00 ุฌ</p>
        <p>๐ ุชูููุฉ ุงูุดุญู (1.65 ูู): 12.60 ุฌ</p>
        <hr>
        <p>๐ฐ ุงูุฅุฌูุงูู: 59.40 ุฌ</p>
      </div>
    </div>
    <button class="print-btn" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงููุงุชูุฑุฉ</button>
  </div>
</div>

<!-- ุชุถููู ุงูููุชุจุงุช ุงูุฎุงุฑุฌูุฉ -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script src="paymob.js"></script>

<!-- ุณูุฑูุจุช ุงูุตูุญุฉ -->
<script>
  // ุชููุฆุฉ ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  emailjs.init("UPtxd1MC2SrpDzWal");

  // ุซูุงุจุช ุงูุญุณุงุจ
  const vatRate = 0.0;
  const discountRate = 0.1;
  const storeCoords = [29.97325, 31.26739]; // ูููุน ุงููุชุฌุฑ

  // ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูุณูุฉ - ุฅุถุงูุฉ ุจูุงูุงุช ุงุฎุชุจุงุฑูุฉ ุฅุฐุง ูุงูุช ุงูุณูุฉ ูุงุฑุบุฉ
  let cart = JSON.parse(localStorage.getItem("cart")) || {};
  
  // ููุงุฎุชุจุงุฑ: ุฅุฐุง ูุงูุช ุงูุณูุฉ ูุงุฑุบุฉุ ุฃุถู ุจุนุถ ุงูููุชุฌุงุช ููุนุฑุถ
  if (Object.keys(cart).length === 0) {
    console.log("ุงูุณูุฉ ูุงุฑุบุฉุ ุฅุถุงูุฉ ุจูุงูุงุช ุงุฎุชุจุงุฑูุฉ");
    cart = {
      "1": { id: "1", name: "ููุชุฌ ุชุฌุฑูุจู 1", price: 100, quantity: 2 },
      "2": { id: "2", name: "ููุชุฌ ุชุฌุฑูุจู 2", price: 150, quantity: 1 }
    };
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  // ุฏุงูุฉ ุญุณุงุจ ุชูููุฉ ุงูุดุญู
  function calculateShippingCost(km) {
    if (km <= 1) return 10;
    return 10 + (km - 1) * 4;
  }

  // ุฏุงูุฉ ุญุณุงุจ ุงููุณุงูุฉ ุจูู ููุทุชูู (ุฅุญุฏุงุซูุงุช GPS) ุจุงููููููุชุฑ
  function haversineDistance(coords1, coords2) {
    if (!coords1 || !coords2 || coords1.length !== 2 || coords2.length !== 2) {
      return 0;
    }
    
    const [lat1, lon1] = coords1;
    const [lat2, lon2] = coords2;
    
    const toRad = angle => angle * Math.PI / 180;
    const R = 6371; // ูุตู ูุทุฑ ุงูุฃุฑุถ ุจุงููููููุชุฑ

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // ุฏุงูุฉ ุนุฑุถ ุงููุงุชูุฑุฉ
  function renderInvoice() {
    const invoiceEl = document.getElementById("invoice");
    
    if (!invoiceEl) {
      console.error("ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุตุฑ ุงููุงุชูุฑุฉ!");
      return;
    }
    
    if (Object.keys(cart).length === 0) {
      invoiceEl.innerHTML = "<p>ุงูุณูุฉ ูุงุฑุบุฉ.</p>";
      return;
    }

    let subtotal = 0;
    let rows = "";

    for (let id in cart) {
      const item = cart[id];
      const totalItem = item.quantity * item.price;
      subtotal += totalItem;

      rows += `
        <tr>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td>${totalItem.toFixed(2)} ุฌ</td>
        </tr>`;
    }

    const discount = subtotal * discountRate;
    const vat = (subtotal - discount) * vatRate;

    // ุงุญุณุจ ุงูุดุญู ูู ูููุฉ ูุญููุธุฉ ูู localStorage
    const distance = parseFloat(localStorage.getItem("distance_km") || "0");
    const shippingCost = calculateShippingCost(distance);

    const total = subtotal - discount + vat + shippingCost;
    localStorage.setItem("checkoutTotal", total.toFixed(2));

    invoiceEl.innerHTML = `
      <table>
        <thead>
          <tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="summary">
        <p>๐ต ุงููุจูุบ: ${subtotal.toFixed(2)} ุฌ</p>
        <p>๐ ุงูุฎุตู (${discountRate * 100}%): ${discount.toFixed(2)} ุฌ</p>
        <p>๐งพ ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (${vatRate * 100}%): ${vat.toFixed(2)} ุฌ</p>
        <p>๐ ุชูููุฉ ุงูุดุญู (${distance} ูู): ${shippingCost.toFixed(2)} ุฌ</p>
        <hr>
        <p>๐ฐ ุงูุฅุฌูุงูู: ${total.toFixed(2)} ุฌ</p>
      </div>
    `;
  }

  // ุงุณุชูุน ูุชุบููุฑุงุช ูู ุงุฎุชูุงุฑ ุงููููุน
  document.getElementById("locationSelect").addEventListener("change", function() {
    const selectedValue = this.value;
    
    if (selectedValue.includes(",")) {
      // ุฅุฐุง ูุงูุช ุงููููุฉ ุชุญุชูู ุนูู ูุงุตูุฉุ ููู ุฅุญุฏุงุซูุงุช
      const coords = selectedValue.split(",").map(Number);
      const distance = haversineDistance(storeCoords, coords);
      localStorage.setItem("distance_km", distance.toFixed(2));
    } else {
      // ุฅุฐุง ูุงูุช ุงููููุฉ ูุตูุฉ (ุงุณู ููุทูุฉ)ุ ูุณุชุฎุฏู ูุณุงูุฉ ุงูุชุฑุงุถูุฉ
      localStorage.setItem("distance_km", "5.00");
    }
    
    // ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุจุนุฏ ุชุบููุฑ ุงููููุน
    renderInvoice();
  });

  // ูุนุงูุฌุฉ ุชูุฏูู ุงููููุฐุฌ
  document.getElementById("checkout-form").addEventListener("submit", function(e) {
    e.preventDefault();

    const formData = Object.fromEntries(new FormData(this));
    const orderData = {
      ...formData,
      cart,
      date: new Date().toLocaleDateString('ar-EG')
    };

    localStorage.setItem("orderData", JSON.stringify(orderData));

    // ุญุณุงุจ ุงูุฅุฌูุงูู
    let subtotal = 0;
    let itemList = "";
    for (let id in cart) {
      const item = cart[id];
      const totalItem = item.quantity * item.price;
      subtotal += totalItem;
      itemList += `${item.name} ร ${item.quantity} = ${totalItem.toFixed(2)} ุฌููู\n`;
    }

    const discount = subtotal * discountRate;
    const vat = (subtotal - discount) * vatRate;
    const shippingCost = calculateShippingCost(parseFloat(localStorage.getItem("distance_km") || "0"));
    const total = subtotal - discount + vat + shippingCost;

    // ุฅุฑุณุงู ุงูุฅูููู
    if (orderData.email) {
      emailjs.send("service_5pcglet", "template_cmu4qhs", {
        name: orderData.name,
        phone: orderData.phone,
        address: orderData.address || "ูู ูุชู ุฅุฏุฎุงู ุนููุงู",
        paymentMethod: orderData["payment-method"] === "cod" ? "ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู" : "ุจุทุงูุฉ ุงุฆุชูุงู",
        items: itemList,
        total: total.toFixed(2),
        date: orderData.date,
        to_email: orderData.email
      }).then(() => {
        alert("โ ุชู ุฅุฑุณุงู ุงููุงุชูุฑุฉ ุนูู ุฅููููู ุจูุฌุงุญ");
      }).catch(err => {
        console.error("โ ูุดู ูู ุฅุฑุณุงู ุงูุฅูููู:", err);
      });
    }
  });

  // ุนุฑุถ ุงููุงุชูุฑุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
  document.addEventListener("DOMContentLoaded", function() {
    // ุชุนููู ูุณุงูุฉ ุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    if (!localStorage.getItem("distance_km")) {
      localStorage.setItem("distance_km", "0.00");
    }
    
    renderInvoice();
  });
</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>


</body></html>
